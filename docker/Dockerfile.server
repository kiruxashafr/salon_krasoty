FROM node:20-alpine

WORKDIR /app

# Устанавливаем runtime зависимости + curl для healthcheck
RUN apk add --no-cache \
    vips \
    python3 \
    make \
    g++ \
    curl

# Копируем package.json отдельно для кэширования
COPY package*.json ./

# Устанавливаем npm зависимости
RUN npm install --production

# Копируем остальные файлы
COPY server.js ./
COPY config/ ./config/

EXPOSE ${PORT}

CMD ["node", "server.js"]